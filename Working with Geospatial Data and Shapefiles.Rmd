---
title: "Working with Geospatial Data and Shapefiles"
author: "Andrew Pierson"
date: "1/14/2019"
output: html_document
---


#### A noticeable pattern in the choropleth map titled Average Household Size of Renters is that renter household size typically tends to be larger in Missouri and Kansas and smaller in Iowa. Another pattern within Average Household Size of Renters is that renter household size in northern and southern Missouri are greater than anywhere else in the state. In the map Average Household Size of Owners the state of Missouri choropleth reveals that there is a larger population of home owners with large household sizes on the east side of the state. 

```{r Part A Task 1, warning = FALSE, message = FALSE, tidy = TRUE}
knitr::opts_chunk$set(echo = TRUE)
#Set working directory manually
setwd('E:/Rockhurst University/WS19/A Term/BIA 6313 Spatial and GIS Analytics/Homework 1/County_2010Census_DP1/')
library(rgdal)
library(GISTools)
#Load in the layer files
county <- readOGR(".","County_2010Census_DP1")
#Shapefile of the United States
plot(county, main="US Map")
#Print out headers for data attached to the shapefile
head(county@data)
#Delimit firsdt two digits of column to represent state code
county@data$STATE <- substr(county@data$GEOID10,1,2)
#Print out headers for data attached to the shapefile
head(county@data)
#Define the polygon associated with only missouri which is state 29
mo <- county[county@data$STATE==29,]
#Print out headers for data attached to the shapefile
head(mo@data)
#Define the polygon associated with only kansas which is state 20
ks <- county[county@data$STATE==20,]
#Define the polygon associated with only iowa which is state 19
ia <- county[county@data$STATE==19,]
#Check the class information of the states
class(mo)
class(ks)
class(ia)
#Plot missouri
plot(mo)
title(main = "Missouri")
#Plot kansas
plot(ks)
title(main = "Kansas")
#Plot iowa
plot(ia)
title(main = "Iowa")
#Combine spatial polygon dataframes 
tri_state <- rbind(ia,ks,mo)
#Plot the tri state spatial polygon
plot(tri_state)
title(main = "Tri-State Area")
#Plot choropleth of household renter size in the tri-state
vacant.shades <- auto.shading(county$DP0230002, cols=brewer.pal(5,"Reds"), cutter=rangeCuts, n=5)
choropleth(tri_state, county$DP0230002, shading=vacant.shades)
choro.legend(533000,161000,vacant.shades)
title(main = "Average Household Size of Renters")
#Plot choropleth of household owner size in the tri state
vacant.shades <- auto.shading(county$DP0230002, cols=brewer.pal(5,"Blues"), cutter=rangeCuts, n=5)
choropleth(mo, county$DP0230002, shading=vacant.shades)
choro.legend(533000,161000,vacant.shades)
title(main = "Average Household Size of Owners")
```


#### The choropleth map of county corn yields in the tri-state area reveals that Kansas and Missouri both have much higher corn yields than Kansas. 

```{r Part A Task 2, warning = FALSE, message = FALSE, tidy = TRUE}
#Remove all census data attached to the tri-state shapefile 
tri_state_shapefile <- tri_state[,1:2]
#The resulting data frame from the shapefile
head(tri_state_shapefile@data)
#Set working directory manually
setwd('E:/Rockhurst University/WS19/A Term/BIA 6313 Spatial and GIS Analytics/Homework 1/County_2010Census_DP1/')
#Load in the corn csv
corn <- read.csv('corn.csv')
#The head of the corn data fram
head(corn)
#Merge the corn csv with the tri_state_shapefile on the GEOID10
tri_state_corn <- merge(corn, tri_state_shapefile)
#Resulting data frame
head(tri_state_corn)
#Plot choropleth
vacant.shades <- auto.shading(tri_state_corn$CORN_YIELD, cols=brewer.pal(5,"Greens"), cutter=rangeCuts, n=5)
choropleth(tri_state, tri_state_corn$CORN_YIELD, shading=vacant.shades)
choro.legend(533000,161000,vacant.shades)
title(main = "Tri-State Corn Yields")
```


### Task 3

```{r Part A Task 3, warning = FALSE, message = FALSE, tidy = TRUE}
#Load in leaflet package
library(leaflet)
#Use the leaflet function producing an empty map and add layering using pipes
imap <- leaflet() %>% addTiles() %>% setView(lng = -94.397041, lat = 38.882149, zoom = 9)
#Plot the view of the map
imap
#Overlay raster data with real-time weather to the map
imap %>% addWMSTiles("http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi", layers = "nexrad-n0r-900913", group = "base_reflect", options = WMSTileOptions(format = "image/png", transparent = TRUE), attribution = "Weather data ? 2012 IEM Nexrad")
```


#### In this choropleth map of the overdoses in the United States there are a couple patterns that are noticeable in the New England region and the noth-west region of the United States. These trends show that there were a higher number of total deaths in those areas during May of 2017.

```{r Part A Task 4_1, warning = FALSE, message = FALSE, tidy = TRUE}
#Load packages
library(tidyr)
library(tidyverse)
#Set the working directory of the file
setwd('E:/Rockhurst University/WS19/A Term/BIA 6313 Spatial and GIS Analytics/Homework 1/')
#Read in the overdose dataset
overdose <- read.csv('VSRR_Provisional_Drug_Overdose_Death_Counts.csv')
#View the head of the data frame
head(overdose)
#See the different categorical variables in the Indicator dimension
levels(overdose$Indicator)
#Filter data down to May 2017
overdose <- overdose %>% filter(overdose$Month == 'May' & overdose$Year == '2017' & overdose$State.Name != 'US' & overdose$State.Name != 'DC' & overdose$State.Name != 'YC')
#Check to make sure the extra regions were omitted
levels(overdose$State.Name)
#Use the spread function to get a 'Cocaine (T40.5)' dimension
#overdose <- overdose %>% gather(key = Indicator, value = Data.Value) 
overdose <- overdose %>% mutate(row = row_number()) %>% spread(key = Indicator, value = Data.Value)
#Rename the column to more user friendly names
overdose <- overdose %>% rename("Abbv State" = "ï..State", "State Name" = "State.Name", "Year" = "Year", "Month" = "Month", "Predicted Value" = "Predicted.Value", "Percent Complete" = "Percent.Complete", "Percent Pending Investigation" = "Percent.Pending.Investigation", "Cocaine" = "Cocaine (T40.5)", "Heroin" = "Heroin (T40.1)", "Methadone" = "Methadone (T40.3)", "Natural & Semi-Synthetic Opioids" = "Natural & semi-synthetic opioids (T40.2)", "Number of Deaths" = "Number of Deaths", "Number of Drug Overdose Deaths" = "Number of Drug Overdose Deaths", "Opioids" = "Opioids (T40.0-T40.4,T40.6)", "Percent With Drugs Specified" = "Percent with drugs specified", "Psychostimulants" = "Psychostimulants with abuse potential (T43.6)", "Synthetic Opioids" = "Synthetic opioids, excl. methadone (T40.4)")
#Determine the number of columns to change
colnames(overdose)
#Change columns 9, 10, 11, 12, 17, 18 to numeric format 
overdose[, c(9:18)] <- sapply(overdose[, c(9:18)], as.numeric)
#Replace NA values with 0
overdose[is.na(overdose)] <- 0
#Check the data types of the new columns
sapply(overdose, class)
#Create new column representing the sum of cocaine, heroin, methadone, natural & semi-synthetic opioids, psychostimulants, and synthetic opioids excluding methadone
overdose <- overdose %>% mutate("Total Deaths" = overdose$Cocaine + overdose$Heroin + overdose$Methadone + overdose$`Natural & Semi-Synthetic Opioids` + overdose$Psychostimulants + overdose$`Synthetic Opioids`)
print(overdose)
```

```{r Part A Task 4_2, warning = FALSE, message = FALSE, tidy = TRUE}
#Load packages
library(plotly)
#Set authentication credential
Sys.setenv("plotly_username"="piersonas")
Sys.setenv("plotly_api_key"="KF30YaLIaAg4AtXGqgSv")
#Read in only the data that will be used
overdose <- select(overdose, -c(5, 6, 7, 14, 15))
#Define a tooltip hover feature to show values
overdose$hover <- with(overdose, paste("State:", `State Name`, '<br>', "Cocaine", Cocaine, '<br>', "Heroin", Heroin, '<br>', "Methadone", Methadone, '<br>', "Natural & Semi-Synthetic Opioids", `Natural & Semi-Synthetic Opioids`, '<br>', "Psychostimulants", Psychostimulants, '<br>', "Synthetic Opioids", `Synthetic Opioids`))
#Give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
#Specify some map projection/options
g <- list(scope = 'usa', projection = list(type = 'albers usa'), showlakes = TRUE, lakecolor = toRGB('white'))
#Create the plot
p <- plot_geo(overdose, locationmode = 'USA-states') %>% add_trace(z = ~`Total Deaths`, text = ~hover, locations = ~`Abbv State`, color = ~`Total Deaths`, colors = 'Blues') %>% colorbar(title = "Number of Deaths") %>% layout(title = 'May 2017 Overdose Deaths<br>(Hover for breakdown)', geo = g)
#Create a shareable link to the chart
chart_link = api_create(p, filename = "choropleth-ag")
chart_link
```
